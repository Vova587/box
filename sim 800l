#include <SoftwareSerial.h>
SoftwareSerial SIM800(6, 7); // 8 - RX Arduino (TX SIM800L), 9 - TX Arduino (RX SIM800L)

void setup() {
  // Open serial communications and wait for port to open:
  Serial.begin(9600);
  Serial.println("Start!");
  SIM800.begin(9600);
  delay(20000);
  SIM800.println("AT+IPR=9600\r"); // Скорость порта GSM модуля (на всякий случай);
   Serial.println(ReadGSM());
   delay(2000);
  SIM800.println("AT\r");
  Serial.println(ReadGSM());
  delay(3000);
  SIM800.println("AT+COPS?\r");
  Serial.println(ReadGSM());
  delay(3000);
  SIM800.println("AT+CPAS\r");
  Serial.println(ReadGSM());
  delay(3000);
  SIM800.println("AT+CREG?\r");
  Serial.println(ReadGSM());
  delay(3000);
  SIM800.println("ATI\r");
  Serial.println(ReadGSM());
   delay(3000);
    SIM800.println("AT+CMGF=1\r"); // Configuring TEXT mode
    Serial.println(ReadGSM());
  delay(3000);
    SIM800.println("AT+CMGS=\"80298245148\"\r");//change ZZ with country code and xxxxxxxxxxx with phone number to sms
    Serial.println(ReadGSM());
    SIM800.print("AT+CMGS=\"\r");
    SIM800.print("80298245148");
  SIM800.write(0x22);
  SIM800.write(0x0D);
    SIM800.write(0x0A);
    delay(10000);
    SIM800.print("ok");
    Serial.println(ReadGSM());
   delay(6000);
    SIM800.write(26);
    Serial.println(ReadGSM());
    delay(4000);
  delay(3000);
}

void loop() {
  Serial.println("Loop");
  Serial.println("Trying to setup module");
  bool isSetup = false;
  while (SIM800.available() && !isSetup) {
    SIM800.println("AT+IPR=9600\r");
    if (ReadGSM().length() > 0) {
      isSetup = true;
    }
  }
  Serial.println("Module has been setup");
    SIM800.print("AT+CMGS=\"");
    SIM800.print("80298245148");
    SIM800.write(0x22);
    SIM800.write(0x0D);
    SIM800.write(0x0A);
    delay(10000);
    SIM800.print("ok");
    delay(6000);
    Serial.println(ReadGSM());
    SIM800.write(26);
 SIM800.println("AT+CIPSHUT\r"); //RESPONSE= OK
  Serial.println(ReadGSM());
delay(2000);
 SIM800.println("AT+CIPMUX=0\r"); //RESPONSE= OK
  Serial.println(ReadGSM());
  delay(4000);
  SIM800.println("AT+CGATT=1\r"); //RESPONSE= OK
  Serial.println(ReadGSM());
  delay(2000);
  SIM800.println("AT+CSTT=\"MTS Internet\",\"\",\"\"\r"); //RESPONSE= OK
  Serial.println(ReadGSM());
  delay(10000);
  SIM800.println("AT+CIICR\r"); //RESPONSE= OK
  Serial.println(ReadGSM());
  delay(10000);
  SIM800.println("AT+CIFSR\r"); //RESPONSE= Returns an IP
  Serial.println(ReadGSM());
  delay(10000);
  SIM800.println("AT+CIPSTART=\"TCP\",\"216.58.211.142\", 80\r"); //RESPONSE= CONNECTED OK
  Serial.println(ReadGSM());
  delay(6000);
  SIM800.println("AT+CIPSEND\r"); //RESPONSE= >
  Serial.println(ReadGSM());
  delay(1000);
  SIM800.println("POST http://216.58.211.142/api/integration HTTP/1.1");
  Serial.println(ReadGSM());
  delay(1000);
  SIM800.println("Host: 216.58.211.142");
  Serial.println(ReadGSM());
  delay(1000);
 SIM800.println("Content-Type: application/json");
  Serial.println(ReadGSM());
  delay(1000);
  SIM800.println("Content-Length: 25");
  Serial.println(ReadGSM());
 delay(1000);
 SIM800.println("{\"Celsius\":\"TEMPERATURE\"}");
  Serial.println(ReadGSM());
  delay(1000);
  SIM800.write(0x1A); // Ctrl Z
    Serial.println(ReadGSM());
    delay(20000);
  /*
    After sending all these instructions, I get the following response,
    OK
    HTTP/1.1 200 OK
    Friday December, 22
    +TCPCLOSE=0
    OK
  */
  SIM800.println("AT+CIPCLOSE"); //RESPONSE= OK
  Serial.println(ReadGSM());
  delay(2000);
  SIM800.println("AT+CIPSHUT"); //RESPONSE= OK
  Serial.println(ReadGSM());
  delay(2000);
  delay(4000);
}

String ReadGSM()
{ //функция чтения данных от GSM модуля
  int c;
  String v;
  while (SIM800.available())
  { //сохраняем входную строку в переменную v
    c = SIM800.read();
    v += char(c);
    delay(20);
  }
  return v;
  
}
